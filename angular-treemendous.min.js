!function(e){"use strict";var t=e.$$minErr("treemendous");e.module("treemendous",[]).factory("treemendousParser",["$parse",function(e){var n=/^s*([\s\S]+?)(?:\s+group\s+by\s+([\$\w][\$\w\d]*)(?:\s+as\s+([\$\w][\$\w\d]*))?)?$/;return{parse:function(r){var i=r.match(n);if(!i)throw new t("iexp","Expected expression in the form of '_nodes_ (group by _property_ (as _children_)?)?' but got '{0}'.",r);return{nodeMapper:e(i[1]),groupBy:i[2]||!1,children:i[3]||"children"}}}}]).controller("TreeMendousCtrl",function(){function e(e,t){var i,o,s,c,a={};if("function"==typeof t?t=t(e)||[]:"string"==typeof t?t=e.$eval(t)||[]:Array.isArray(t)&&(t=t),n===!1)return{nodes:t};if(e.$intermediate===!0)return{nodes:t,$intermediate:!1};for(i=0,o=t.length;o>i;i++)s=t[i],c=s[n],a[c]?a[c][r].push(s):(a[c]={},a[c][r]=[s],a[c][n]=c);return{$intermediate:!0,nodes:Object.keys(a).map(function(e){return a[e]})}}var n=!1,r="children";this.selectMode="none",this.selectScopes=[],this.transclude=null,this.parserResult=null,this.setParserResult=function(e){this.parserResult=e,n=e.groupBy,r=e.children},this.watchNodes=function(n,r,i){var o=Array.isArray(i)?"array":typeof i;if(["function","string","array"].indexOf(o)<0)throw new t("type","Expected watchExp to be a function, string or array but got '{0}'.",o);r.$watchCollection(i,function(){var t=e(r,i);n.$intermediate=t.$intermediate,n.nodes=t.nodes})},this.select=function(e){var t,n,r,i=this.selectMode;if("none"!=i&&(e.$selected=!0,"active"==i&&(e.$active=!0),"single"==i||"active"==i))for(t=0,n=this.selectScopes.length;n>t;t++)r=this.selectScopes[t],r!==e&&(r.$selected=!1)}}).directive("treeMendous",["treemendousParser",function(e){var t={single:"single",multi:"multi",active:"active",none:"none"};return{restrict:"EA",transclude:!0,controller:"TreeMendousCtrl",link:function(n,r,i,o,s){o.selectMode=t[i.selectMode]||"none",o.transclude=s,o.setParserResult(e.parse(i.nodes));var c=n.$new();s(c,function(e){r.append(e)}),o.watchNodes(c,n,o.parserResult.nodeMapper)}}}]).directive("treeBranch",function(){return{restrict:"EA",require:"^treeMendous",link:function(e,t,n,r){var i=e.$new();r.transclude(i,function(e){t.append(e)}),r.watchNodes(i,e,n.nodes)}}}).directive("treeSelect",["$parse","$q","$timeout",function(t,n,r){return{restrict:"A",require:"^treeMendous",link:function(i,o,s,c){var a,u;i.$selected=!1,i.$active=!1,c.selectScopes.push(i),a=s.treeSelect?t(s.treeSelect):e.noop,o.on("click",function(e){e.stopPropagation();var t=!u;if(r.cancel(u),u=r(function(){u=null},300),t){if(i.$selected)return i.$apply(function(){i.$active&&(i.$active=!1),i.$selected=!1});n.when(a(i,{$event:e})).then(function(e){e!==!1&&c.select(i)})}})}}}]).directive("treeExpand",["$parse","$q",function(t,n){return{restrict:"A",require:"^treeMendous",link:function(r,i,o){var s,c=void 0===o.treeSelect?"click":"dblclick";r.$expanded=!1,s=o.treeExpand?t(o.treeExpand):e.noop,i.on(c,function(e){return e.stopPropagation(),r.$expanded?r.$apply(function(){r.$expanded=!1}):void n.when(s(r,{$event:e})).then(function(e){e!==!1&&(r.$expanded=!0)})})}}}])}(angular);