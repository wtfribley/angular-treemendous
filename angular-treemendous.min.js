!function(e){"use strict";var t=e.$$minErr("treemendous");e.module("treemendous",["ngAnimate"]).factory("treemendousParser",["$parse",function(e){var n=/^s*([\s\S]+?)(?:\s+group\s+by\s+([\$\w][\$\w\d]*)(?:\s+as\s+([\$\w][\$\w\d]*))?)?$/;return{parse:function(r){var s=r.match(n);if(!s)throw new t("iexp","Expected expression in the form of '_nodes_ (group by _property_ (as _children_)?)?' but got '{0}'.",r);return{nodeMapper:e(s[1]),groupBy:s[2]||!1,children:s[3]||"children"}}}}]).controller("TreeMendousCtrl",["$animate",function(e){function n(e,t){var n,i,o={};if("function"==typeof t?t=t(e)||[]:"string"==typeof t?t=e.$eval(t)||[]:Array.isArray(t)&&(t=t),r===!1)return{nodes:t};if(e.$intermediate===!0)return{nodes:t,$intermediate:!1};for(var c=0,a=t.length;a>c;c++)n=t[c],i=n[r],o[i]?o[i][s].push(n):(o[i]={},o[i][s]=[n],o[i][r]=i);return{$intermediate:!0,nodes:Object.keys(o).map(function(e){return o[e]})}}var r=!1,s="children";this.selectMode="none",this.selectElements=[],this.transclude=null,this.parserResult=null,this.setParserResult=function(e){this.parserResult=e,r=e.groupBy,s=e.children},this.watchNodes=function(e,r,s){var i=Array.isArray(s)?"array":typeof s;if(["function","string","array"].indexOf(i)<0)throw new t("type","Expected watchExp to be a function, string or array but got '{0}'.",i);r.$watchCollection(s,function(){var t=n(r,s);e.$intermediate=t.$intermediate,e.nodes=t.nodes})},this.select=function(t){var n=this.selectMode;if("none"!=n){if("single"==n||"active"==n)for(var r=0,s=this.selectElements.length;s>r;r++)e.removeClass(this.selectElements[r],"selected");e.addClass(t,"selected"),"active"==n&&e.addClass(t,"active")}},this.deselect=function(t){t.hasClass("active")&&e.removeClass(t,"active"),e.removeClass(t,"selected")},this.registerSelectElement=function(e){var t=this.selectElements;return t.push(e),function(){t.splice(t.indexOf(e),1)}}}]).directive("treeMendous",["treemendousParser",function(e){var t={single:"single",multi:"multi",active:"active",none:"none"};return{restrict:"EA",transclude:!0,controller:"TreeMendousCtrl",link:function(n,r,s,i,o){i.selectMode=t[s.selectMode]||"none",i.transclude=o,i.setParserResult(e.parse(s.nodes));var c=n.$new();o(c,function(e){r.append(e)}),i.watchNodes(c,n,i.parserResult.nodeMapper)}}}]).directive("treeBranch",function(){return{restrict:"EA",require:"^treeMendous",link:function(e,t,n,r){var s=e.$new();r.transclude(s,function(e){t.append(e)}),r.watchNodes(s,e,n.nodes)}}}).directive("treeSelect",["$parse","$q","$timeout",function(e,t,n){return{restrict:"A",require:"^treeMendous",link:function(r,s,i,o){var c=function(){return!0},a=null,u=o.registerSelectElement(s);r.$on("$destroy",u),i.treeSelect&&(c=e(i.treeSelect)),s.on("click",function(e){e.stopPropagation();var i=!a;if(n.cancel(a),a=n(function(){a=null},300),i){if(s.hasClass("selected"))return o.deselect(s);t.when(c(r,{$event:e})).then(function(e){e!==!1&&o.select(s)})}})}}}]).directive("treeExpand",["$parse","$q",function(t,n){return{restrict:"A",require:"^treeMendous",link:function(r,s,i){var o,c=void 0===i.treeSelect?"click":"dblclick";r.$expanded=!1,o=i.treeExpand?t(i.treeExpand):e.noop,s.on(c,function(e){return e.stopPropagation(),r.$expanded?r.$apply(function(){r.$expanded=!1}):void n.when(o(r,{$event:e})).then(function(e){e!==!1&&(r.$expanded=!0)})})}}}])}(angular);