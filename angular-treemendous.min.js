!function(e){"use strict";var n=e.$$minErr("treemendous");e.module("treemendous",["ngAnimate"]).factory("treemendousParser",["$parse",function(e){var t=/^s*([\s\S]+?)(?:\s+group\s+by\s+([\$\w][\$\w\d]*)(?:\s+as\s+([\$\w][\$\w\d]*))?)?$/;return{parse:function(r){var i=r.match(t);if(!i)throw n("iexp","Expected expression in the form of '_nodes_ (group by _property_ (as _children_)?)?' but got '{0}'.",r);return{nodes:e(i[1]),groupBy:i[2]||!1,children:i[3]||"children"}}}}]).controller("TreeMendousCtrl",["$animate","treemendousParser",function(e,n){this.transclude=null,this.expression="",this.selectMode="none";var t,r=[],i=[];this.registerSelect=function(e,n){return r.push(e),i.push(n),function(){var t=r.indexOf(e),s=i.indexOf(n);t>-1&&r.splice(t,1),s>-1&&i.splice(s,1)}},this.select=function(n,t){if("none"!=this.selectMode&&~r.indexOf(n)){if(~["single","active"].indexOf(this.selectMode))for(var s=0,c=r.length;c>s;s++)e.removeClass(r[s],"selected"),i[s].$selected=!1;e.addClass(n,"selected"),t.$selected=!0,"active"==this.selectMode&&(e.addClass(n,"active"),t.$active=!0)}},this.deselect=function(n,t){e.removeClass(n,"active"),e.removeClass(n,"selected"),t.$active=!1,t.$selected=!1},this.expand=function(n,t){e.removeClass(n,"tree-branch-collapsed"),e.addClass(n,"tree-branch-expanded"),t.$expanded=!0},this.collapse=function(n,t){e.removeClass(n,"tree-branch-expanded"),e.addClass(n,"tree-branch-collapsed"),t.$expanded=!1},this.watch=function(e,r,i){t||(t=n.parse(this.expression));var s=i?n.parse(i).nodes:t.nodes;r.$watchCollection(s,function(n){function i(e){for(var n,r,i=t.children,s=t.groupBy,c={},o=0,a=e.length;a>o;o++)r=e[o],n=r[s],c[n]?c[n][i].push(r):(c[n]={},c[n][i]=[r],c[n][s]=n);return Object.keys(c).map(function(e){return c[e]})}return n?!t.groupBy||r.$intermediate?(e.$intermediate=!1,e.nodes=n):(e.$intermediate=!0,void(e.nodes=i(n))):e.nodes=[]})}}]).directive("treeMendous",function(){var e={single:"single",multi:"multi",active:"active",none:"none"};return{restrict:"EA",transclude:!0,controller:"TreeMendousCtrl",link:function(n,t,r,i,s){i.selectMode=e[r.selectMode]||"none",i.transclude=s,i.expression=r.nodes||"";var c=n.$new();s(c,function(e){t.append(e)}),i.watch(c,n)}}}).directive("treeBranch",function(){return{restrict:"EA",require:"^treeMendous",link:function(e,n,t,r){var i=e.$new();r.transclude(i,function(e){n.append(e)}),r.watch(i,e,t.nodes)}}}).directive("treeSelect",["$q","$timeout",function(e,n){return{restrict:"EA",require:"^treeMendous",link:function(t,r,i,s){if("none"!=s.selectMode){var c=i.selectOn||"click",o=i.treeSelect||i.selectIf||!0,a=null;t.$on("$destroy",s.registerSelect(r,t)),t.$selected=!1,t.$active=!1,r.on(c,function(i){var l=!0;if(i.stopPropagation(),"click"==c&&(l=!a,n.cancel(a),a=n(function(){a=null},300)),l){if(t.$selected)return t.$apply(function(){s.deselect(r,t)});e.when(t.$eval(o,{$event:i})).then(function(e){e!==!1&&s.select(r,t)})}})}}}}]).directive("treeExpand",["$q","$timeout",function(e,n){return{restrict:"EA",require:"^treeMendous",link:function(t,r,i,s){var c=i.expandOn||"click";void 0===i.treeSelect&&"tree-select"!=r[0].tagName&&"data-tree-select"!=r[0].tagName||i.expandOn||(c="dblclick");var o=i.treeExpand||i.expand||!0,a=null;t.$expanded=!1,r.on(c,function(i){var l=!0;if(i.stopPropagation(),"click"==c&&(l=!a,n.cancel(a),a=n(function(){a=null},300)),l){if(t.$expanded)return t.$apply(function(){s.collapse(r,t)});e.when(t.$eval(o,{$event:i})).then(function(e){e!==!1&&s.expand(r,t)})}})}}}])}(angular);